<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Referral - GoSembako</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/utils.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .referral-code-box {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .share-btn {
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .share-btn:hover { transform: translateY(-2px); }
        .tab-btn {
            padding: 12px 24px;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }
        .history-item {
            padding: 16px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-warning { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-green-700 text-white py-4 shadow-md fixed z-50 w-full">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="assets/img/logo.webp" alt="GoSembako" class="h-12 w-auto">
                <h1 class="text-xl font-bold">GoSembako - Dashboard Referral</h1>
            </div>
            <a href="akun.html" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition">Kembali ke Akun</a>
        </div>
    </header>

    <main class="container mx-auto px-4 pt-24 pb-12">
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <div class="loading mx-auto"></div>
            <p class="text-gray-600 mt-4">Memuat data referral Anda...</p>
        </div>

        <!-- Main Content (Hidden on load) -->
        <div id="main-content" class="hidden">
            <!-- Not Logged In State -->
            <div id="not-logged-in" class="text-center py-12">
                <div class="text-6xl mb-4">üîê</div>
                <h2 class="text-2xl font-bold mb-4">Silakan Login Terlebih Dahulu</h2>
                <p class="text-gray-600 mb-6">Anda harus login untuk melihat dashboard referral Anda.</p>
                <a href="akun.html" class="bg-green-700 hover:bg-green-800 text-white px-6 py-3 rounded-lg inline-block transition">
                    Ke Halaman Login
                </a>
            </div>

            <!-- Logged In Content -->
            <div id="logged-in-content" class="hidden">
                <!-- Welcome Section -->
                <div class="bg-gradient-to-r from-green-700 to-green-800 text-white rounded-lg p-8 mb-8 card-shadow">
                    <h1 class="text-3xl font-bold mb-2" id="welcome-name">Halo, Pengguna!</h1>
                    <p class="text-green-100">Bagikan referral link Anda dan dapatkan poin reward!</p>
                </div>

                <!-- Referral Code Section -->
                <div class="bg-white rounded-lg p-8 mb-8 card-shadow">
                    <h2 class="text-2xl font-bold mb-6">üìã Kode Referral Anda</h2>
                    
                    <div class="referral-code-box mb-6">
                        <p class="text-gray-600 text-sm mb-2">Kode Referral Unik Anda:</p>
                        <p class="text-4xl font-bold text-purple-600 mb-4" id="referral-code">LOADING...</p>
                        <p class="text-gray-600 text-sm mb-4">Bagikan kode ini kepada teman untuk mendapat poin reward</p>
                        <button onclick="copyReferralLink()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition">
                            üìã Salin Link Referral
                        </button>
                    </div>

                    <!-- Share Buttons -->
                    <h3 class="text-lg font-bold mb-4">üîó Bagikan Ke:</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="shareViaWhatsApp()" class="share-btn bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg justify-center transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.335-1.662c1.72.937 3.659 1.432 5.631 1.433h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            WhatsApp
                        </button>
                        <button onclick="shareViaFacebook()" class="share-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg justify-center transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                            Facebook
                        </button>
                        <button onclick="shareViaTwitter()" class="share-btn bg-sky-500 hover:bg-sky-600 text-white px-4 py-3 rounded-lg justify-center transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 002.856-10.02 10 10 0 01-2.956 1.137 4.99 4.99 0 001.738-2.765 9.98 9.98 0 01-3.03 1.156 4.993 4.993 0 00-8.58 4.55A14.97 14.97 0 011.07 4.69a4.993 4.993 0 001.546 6.671 4.936 4.936 0 01-2.261-.569v.062a4.993 4.993 0 003.997 4.904 4.996 4.996 0 01-2.252.085 4.994 4.994 0 004.659 3.468A10.01 10.01 0 010 19.54a14.976 14.976 0 008.162 2.388c9.795 0 15.135-8.116 15.135-15.177 0-.231-.005-.461-.015-.69a10.758 10.758 0 002.635-2.74z"/></svg>
                            Twitter
                        </button>
                        <button onclick="copyReferralLink()" class="share-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg justify-center transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            Salin
                        </button>
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="text-4xl font-bold mb-2" id="stat-referred">0</div>
                        <p class="text-sm opacity-90">Orang Direferensikan</p>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-bold mb-2" id="stat-completed">0</div>
                        <p class="text-sm opacity-90">Pembelian Selesai</p>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-bold mb-2" id="stat-pending">0</div>
                        <p class="text-sm opacity-90">Menunggu Pembelian</p>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-bold mb-2" id="stat-points">0</div>
                        <p class="text-sm opacity-90">Total Poin</p>
                    </div>
                </div>

                <!-- Tabs Section -->
                <div class="bg-white rounded-lg card-shadow">
                    <!-- Tab Navigation -->
                    <div class="flex border-b border-gray-200">
                        <button class="tab-btn active" onclick="switchTab('referrals')">üë• Daftar Referral</button>
                        <button class="tab-btn" onclick="switchTab('history')">üìä Riwayat Poin</button>
                        <button class="tab-btn" onclick="switchTab('vouchers')">üéüÔ∏è Voucher Saya</button>
                    </div>

                    <!-- Tab: Referrals -->
                    <div id="tab-referrals" class="tab-content p-6">
                        <h3 class="text-lg font-bold mb-4">Daftar Orang yang Anda Referensikan</h3>
                        <div id="referrals-list" class="space-y-4">
                            <p class="text-gray-600">Memuat data...</p>
                        </div>
                    </div>

                    <!-- Tab: History -->
                    <div id="tab-history" class="tab-content p-6 hidden">
                        <h3 class="text-lg font-bold mb-4">Riwayat Transaksi Poin</h3>
                        <div id="history-list" class="space-y-4">
                            <p class="text-gray-600">Memuat data...</p>
                        </div>
                    </div>

                    <!-- Tab: Vouchers -->
                    <div id="tab-vouchers" class="tab-content p-6 hidden">
                        <h3 class="text-lg font-bold mb-4">Voucher yang Telah Dikerjain</h3>
                        <div id="vouchers-list" class="space-y-4">
                            <p class="text-gray-600">Anda belum memiliki voucher hasil referral. Ajak teman untuk mendapat voucher!</p>
                        </div>
                    </div>
                </div>

                <!-- How It Works Section -->
                <div class="bg-white rounded-lg p-8 mt-8 card-shadow">
                    <h2 class="text-2xl font-bold mb-6">‚ùì Cara Kerjanya</h2>
                    <div class="grid md:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="text-4xl mb-2">1Ô∏è‚É£</div>
                            <h3 class="font-bold mb-2">Bagikan Link</h3>
                            <p class="text-gray-600 text-sm">Bagikan kode referral Anda ke teman melalui WhatsApp, FB, atau media lainnya</p>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl mb-2">2Ô∏è‚É£</div>
                            <h3 class="font-bold mb-2">Teman Daftar</h3>
                            <p class="text-gray-600 text-sm">Teman Anda klik link dan mendaftar dengan diskon 10% untuk pembelian pertama</p>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl mb-2">3Ô∏è‚É£</div>
                            <h3 class="font-bold mb-2">Teman Belanja</h3>
                            <p class="text-gray-600 text-sm">Teman Anda melakukan pembelian pertama dengan diskon yang Anda berikan</p>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl mb-2">4Ô∏è‚É£</div>
                            <h3 class="font-bold mb-2">Dapatkan Poin</h3>
                            <p class="text-gray-600 text-sm">Anda otomatis mendapat 10.000 poin reward yang bisa ditukar dengan voucher</p>
                        </div>
                    </div>
                </div>

                <!-- FAQ Section -->
                <div class="bg-white rounded-lg p-8 mt-8 card-shadow">
                    <h2 class="text-2xl font-bold mb-6">‚ùì FAQ</h2>
                    <div class="space-y-4">
                        <details class="border border-gray-200 rounded-lg p-4 cursor-pointer group">
                            <summary class="font-bold text-lg flex justify-between">
                                Berapa banyak orang yang bisa saya referensikan?
                                <span class="group-open:rotate-180 transition">‚ñº</span>
                            </summary>
                            <p class="text-gray-600 mt-4">Tidak ada batasan! Anda bisa referensikan sebanyak mungkin teman. Setiap teman yang berhasil membeli, Anda dapat 10.000 poin.</p>
                        </details>
                        <details class="border border-gray-200 rounded-lg p-4 cursor-pointer group">
                            <summary class="font-bold text-lg flex justify-between">
                                Kapan saya dapat poinnya?
                                <span class="group-open:rotate-180 transition">‚ñº</span>
                            </summary>
                            <p class="text-gray-600 mt-4">Poin diberikan secara otomatis setelah teman Anda menyelesaikan pembelian pertama (order berhasil tercatat).</p>
                        </details>
                        <details class="border border-gray-200 rounded-lg p-4 cursor-pointer group">
                            <summary class="font-bold text-lg flex justify-between">
                                Apa itu voucher?
                                <span class="group-open:rotate-180 transition">‚ñº</span>
                            </summary>
                            <p class="text-gray-600 mt-4">Voucher adalah kode diskon yang bisa Anda gunakan untuk pembelian berikutnya. Diskon otomatis diberikan ketika teman Anda berhasil membeli.</p>
                        </details>
                        <details class="border border-gray-200 rounded-lg p-4 cursor-pointer group">
                            <summary class="font-bold text-lg flex justify-between">
                                Apakah teman saya dapat diskon?
                                <span class="group-open:rotate-180 transition">‚ñº</span>
                            </summary>
                            <p class="text-gray-600 mt-4">Ya! Teman Anda dapat diskon 10% (maksimal Rp 25.000) untuk pembelian pertama mereka.</p>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/api-service.js"></script>
    <script src="assets/js/referral-helper.js"></script>
    <script>
        // ‚úÖ FIX: Get logged in user - use correct localStorage key
        function getLoggedInUser() {
            // Check gosembako_user (set by akun.js during login)
            const userJson = localStorage.getItem('gosembako_user');
            if (userJson) {
                try {
                    const user = JSON.parse(userJson);
                    console.log('‚úÖ User found in gosembako_user:', user);
                    return user;
                } catch (e) {
                    console.error('‚ùå Error parsing gosembako_user:', e);
                }
            }
            
            // Fallback: check old 'user' key for backward compatibility
            const oldUserJson = localStorage.getItem('user');
            if (oldUserJson) {
                try {
                    const user = JSON.parse(oldUserJson);
                    console.log('‚úÖ User found in user (legacy):', user);
                    return user;
                } catch (e) {
                    console.error('‚ùå Error parsing user:', e);
                }
            }
            
            console.warn('‚ùå No logged in user found');
            return null;
        }

        // Switch tabs
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // Helper: Get referral code dari user
        function getUserReferralCode() {
            const user = getLoggedInUser();
            return user?.referral_code || user?.whatsapp;
        }

        // Share via WhatsApp
        function shareViaWhatsApp() {
            const code = getUserReferralCode();
            if (!code) {
                alert('Tidak ada kode referral');
                return;
            }
            shareReferralViaWhatsApp(code);
        }

        // Share via Facebook
        function shareViaFacebook() {
            const code = getUserReferralCode();
            if (!code) {
                alert('Tidak ada kode referral');
                return;
            }
            shareReferralViaFacebook(code);
        }

        // Share via Twitter
        function shareViaTwitter() {
            const code = getUserReferralCode();
            if (!code) {
                alert('Tidak ada kode referral');
                return;
            }
            shareReferralViaTwitter(code);
        }

        // Copy referral link
        function copyReferralLink() {
            const code = getUserReferralCode();
            if (!code) {
                alert('Tidak ada data user atau kode referral');
                return;
            }
            console.log('üìã Copying referral code:', code);
            copyReferralLinkToClipboard(code);
        }

        // Show skeleton loading for stats with improved UI
        function showSkeletonLoading() {
            const stats = [
                { id: 'stat-referred', label: 'Direferensikan' },
                { id: 'stat-completed', label: 'Selesai' },
                { id: 'stat-pending', label: 'Menunggu' },
                { id: 'stat-points', label: 'Poin' }
            ];
            
            stats.forEach(stat => {
                const element = document.getElementById(stat.id);
                if (element) {
                    // Create a skeleton loader with better visual appearance
                    element.innerHTML = `
                        <div class="space-y-2">
                            <div class="h-8 bg-gray-300 rounded animate-pulse"></div>
                            <div class="h-4 bg-gray-200 rounded animate-pulse w-2/3 mx-auto"></div>
                        </div>
                    `;
                }
            });
            
            // Also show skeleton for referrals list if exists
            const referralsList = document.getElementById('referrals-list');
            if (referralsList) {
                referralsList.innerHTML = `
                    <div class="space-y-4">
                        ${[1, 2, 3].map(() => `
                            <div class="h-24 bg-gray-200 rounded animate-pulse"></div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Show skeleton for history list if exists
            const historyList = document.getElementById('history-list');
            if (historyList) {
                historyList.innerHTML = `
                    <div class="space-y-4">
                        ${[1, 2, 3].map(() => `
                            <div class="h-20 bg-gray-200 rounded animate-pulse"></div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // Load referral data
        async function loadReferralData() {
            const user = getLoggedInUser();
            
            console.log('üîç Checking user login status:', user);
            
            if (!user) {
                console.warn('‚ùå User not logged in');
                document.getElementById('not-logged-in').classList.remove('hidden');
                document.getElementById('logged-in-content').classList.add('hidden');
                return;
            }

            // Validate user data
            if (!user.referral_code && !user.whatsapp) {
                console.error('‚ùå User data invalid - missing referral_code and whatsapp');
                showErrorMessage('Data pengguna tidak valid. Silakan login kembali.');
                return;
            }

            // Use referral_code or fallback to whatsapp
            const referralCode = user.referral_code || user.whatsapp;
            console.log('‚úÖ User logged in, referral code:', referralCode);

            // Show logged in content
            document.getElementById('not-logged-in').classList.add('hidden');
            document.getElementById('logged-in-content').classList.remove('hidden');
            
            // Update welcome
            document.getElementById('welcome-name').textContent = `Halo, ${user.nama}! üëã`;
            document.getElementById('referral-code').textContent = referralCode;

            // Show skeleton loading
            showSkeletonLoading();

            // Get stats dari GAS
            try {
                console.log('üì° Fetching referral stats...');
                const stats = await getReferralStatsFromGAS(referralCode);
                console.log('üìä Stats response:', stats);
                
                if (stats.success && stats.total_referred !== undefined) {
                    document.getElementById('stat-referred').textContent = stats.total_referred || 0;
                    document.getElementById('stat-completed').textContent = stats.total_completed || 0;
                    document.getElementById('stat-pending').textContent = stats.total_pending || 0;
                    document.getElementById('stat-points').textContent = (stats.total_points || 0).toLocaleString('id-ID');

                    console.log('‚úÖ Stats loaded successfully');

                    // Display referrals
                    if (stats.referrals && Array.isArray(stats.referrals)) {
                        displayReferrals(stats.referrals);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Stats response invalid:', stats);
                    showErrorMessage(`Gagal memuat statistik: ${stats.message || 'Unknown error'}`);
                    // Set default values
                    document.getElementById('stat-referred').textContent = '0';
                    document.getElementById('stat-completed').textContent = '0';
                    document.getElementById('stat-pending').textContent = '0';
                    document.getElementById('stat-points').textContent = '0';
                }
            } catch (error) {
                console.error('‚ùå Error loading stats:', error);
                showErrorMessage(`Kesalahan jaringan: ${error.message}`);
                // Set default values on error
                document.getElementById('stat-referred').textContent = '0';
                document.getElementById('stat-completed').textContent = '0';
                document.getElementById('stat-pending').textContent = '0';
                document.getElementById('stat-points').textContent = '0';
            }

            // Get points history
            try {
                console.log('üì° Fetching points history...');
                const history = await getPointsHistoryFromGAS(referralCode);
                console.log('üìã History response:', history);
                
                if (history.success && history.history && Array.isArray(history.history)) {
                    if (history.history.length > 0) {
                        displayHistory(history.history);
                    } else {
                        document.getElementById('history-list').innerHTML = '<p class="text-gray-600 text-center py-8">Belum ada riwayat poin.</p>';
                    }
                    console.log('‚úÖ History loaded successfully');
                } else {
                    console.warn('‚ö†Ô∏è History response invalid:', history);
                    document.getElementById('history-list').innerHTML = '<p class="text-gray-600 text-center py-8">Gagal memuat riwayat poin.</p>';
                }
            } catch (error) {
                console.error('‚ùå Error loading history:', error);
                document.getElementById('history-list').innerHTML = '<p class="text-gray-600 text-center py-8">Kesalahan memuat riwayat.</p>';
            }
        }

        // Show error message (menggunakan Utils.showError jika tersedia, fallback ke custom)
        function showErrorMessage(message) {
            if (typeof Utils !== 'undefined' && Utils.showError) {
                Utils.showError(message);
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-20 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
                errorDiv.textContent = `‚ö†Ô∏è ${message}`;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
        }

        // State untuk pagination referrals
        let currentReferralsPage = 1;
        const referralsPerPage = 5;
        let allReferralsData = [];

        // Display referrals dengan formatting dan pagination
        function displayReferrals(referrals) {
            const container = document.getElementById('referrals-list');
            
            if (!referrals || referrals.length === 0) {
                container.innerHTML = '<p class="text-gray-600">Anda belum memiliki referral. Mulai bagikan kode Anda!</p>';
                return;
            }

            // Store all referrals data for pagination
            allReferralsData = referrals;
            currentReferralsPage = 1;
            
            // Display first page
            displayReferralsPage(currentReferralsPage);
        }

        // Display specific page of referrals
        function displayReferralsPage(page) {
            const container = document.getElementById('referrals-list');
            const startIndex = (page - 1) * referralsPerPage;
            const endIndex = startIndex + referralsPerPage;
            const pageItems = allReferralsData.slice(startIndex, endIndex);
            
            let html = pageItems.map(ref => {
                const badgeClass = ref.status === 'completed' ? 'badge-success' : 'badge-pending';
                const statusText = ref.status === 'completed' ? '‚úÖ Selesai' : '‚è≥ Menunggu';
                const formattedDate = typeof Utils !== 'undefined' && Utils.formatDate 
                    ? Utils.formatDate(ref.completed_at) 
                    : (ref.completed_at || 'N/A');
                const formattedReward = typeof Utils !== 'undefined' && Utils.formatNumber
                    ? Utils.formatNumber(ref.reward_points)
                    : ref.reward_points.toLocaleString('id-ID');
                
                return `
                    <div class="history-item">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-bold text-lg">${ref.name}</p>
                                <p class="text-gray-600 text-sm">ID: ${ref.id.substring(0, 15)}...</p>
                            </div>
                            <span class="badge ${badgeClass}">${statusText}</span>
                        </div>
                        ${ref.status === 'completed' ? `
                            <p class="text-green-600 font-bold mt-2">‚úÖ Reward: ${formattedReward} Poin</p>
                            <p class="text-gray-600 text-sm">Tanggal: ${formattedDate}</p>
                        ` : `
                            <p class="text-amber-600 text-sm">Menunggu pembelian pertama...</p>
                        `}
                    </div>
                `;
            }).join('');
            
            // Add pagination controls if needed
            const totalPages = Math.ceil(allReferralsData.length / referralsPerPage);
            if (totalPages > 1) {
                html += `
                    <div class="mt-6 flex items-center justify-center gap-2">
                        <button onclick="goToReferralsPage(1)" class="px-3 py-1 rounded border border-gray-300 text-sm" ${page === 1 ? 'disabled' : ''}>¬´</button>
                        <button onclick="goToReferralsPage(${Math.max(1, page - 1)})" class="px-3 py-1 rounded border border-gray-300 text-sm" ${page === 1 ? 'disabled' : ''}>‚Äπ Prev</button>
                        <span class="px-4 py-1 text-sm font-semibold">Halaman ${page} dari ${totalPages}</span>
                        <button onclick="goToReferralsPage(${Math.min(totalPages, page + 1)})" class="px-3 py-1 rounded border border-gray-300 text-sm" ${page === totalPages ? 'disabled' : ''}>Next ‚Ä∫</button>
                        <button onclick="goToReferralsPage(${totalPages})" class="px-3 py-1 rounded border border-gray-300 text-sm" ${page === totalPages ? 'disabled' : ''}>¬ª</button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Navigate to specific referrals page
        function goToReferralsPage(page) {
            const totalPages = Math.ceil(allReferralsData.length / referralsPerPage);
            if (page < 1 || page > totalPages) return;
            currentReferralsPage = page;
            displayReferralsPage(page);
        }

        // State untuk pagination
        let currentHistoryPage = 1;
        const itemsPerPage = 10;
        let allHistoryData = [];

        // Display history dengan pagination
        function displayHistory(history) {
            const container = document.getElementById('history-list');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<p class="text-gray-600">Belum ada riwayat transaksi.</p>';
                return;
            }

            // Store all history data for pagination
            allHistoryData = history;
            currentHistoryPage = 1;
            
            // Display first page
            displayHistoryPage(currentHistoryPage);
        }

        // Display specific page of history
        function displayHistoryPage(page) {
            const container = document.getElementById('history-list');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = allHistoryData.slice(startIndex, endIndex);
            
            let html = pageItems.map(item => {
                const formattedDate = typeof Utils !== 'undefined' && Utils.formatDate
                    ? Utils.formatDate(item.date)
                    : item.date;
                const formattedChange = typeof Utils !== 'undefined' && Utils.formatNumber
                    ? Utils.formatNumber(item.change)
                    : item.change.toLocaleString('id-ID');
                const formattedBefore = typeof Utils !== 'undefined' && Utils.formatNumber
                    ? Utils.formatNumber(item.before)
                    : item.before.toLocaleString('id-ID');
                const formattedAfter = typeof Utils !== 'undefined' && Utils.formatNumber
                    ? Utils.formatNumber(item.after)
                    : item.after.toLocaleString('id-ID');
                
                return `
                    <div class="history-item">
                        <div class="flex justify-between items-start mb-2">
                            <p class="font-bold">${item.description}</p>
                            <span class="text-green-600 font-bold text-lg">+${formattedChange}</span>
                        </div>
                        <p class="text-gray-600 text-sm">${formattedDate}</p>
                        <p class="text-gray-600 text-sm">Saldo: ${formattedBefore} ‚Üí ${formattedAfter}</p>
                    </div>
                `;
            }).join('');
            
            // Add pagination controls if needed
            const totalPages = Math.ceil(allHistoryData.length / itemsPerPage);
            if (totalPages > 1) {
                html += `
                    <div class="mt-6 flex items-center justify-center gap-2">
                        <button onclick="goToHistoryPage(1)" class="px-3 py-1 rounded border border-gray-300 text-sm" ${page === 1 ? 'disabled' : ''}>¬´</button>
                        <button onclick="goToHistoryPage(${Math.max(1, page - 1)})" class="px-3 py-1 rounded border border-gray-300 text-sm" ${page === 1 ? 'disabled' : ''}>‚Äπ Prev</button>
                        <span class="px-4 py-1 text-sm font-semibold">Halaman ${page} dari ${totalPages}</span>
                        <button onclick="goToHistoryPage(${Math.min(totalPages, page + 1)})" class="px-3 py-1 rounded border border-gray-300 text-sm" ${page === totalPages ? 'disabled' : ''}>Next ‚Ä∫</button>
                        <button onclick="goToHistoryPage(${totalPages})" class="px-3 py-1 rounded border border-gray-300 text-sm" ${page === totalPages ? 'disabled' : ''}>¬ª</button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Navigate to specific history page
        function goToHistoryPage(page) {
            const totalPages = Math.ceil(allHistoryData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentHistoryPage = page;
            displayHistoryPage(page);
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            loadReferralData();
        });
    </script>
</body>
</html>
