const normalizePhoneTo08=e=>{const r=(e||"").toString().replace(/[^0-9]/g,"");if(!r)return"";let t=r;return t.startsWith("62")&&(t=t.slice(2)),t.startsWith("0")&&(t=t.slice(1)),t.startsWith("8")?"0"+t:""},DEFAULT_REFERRAL_REWARD_POINTS=50;async function fetchAllReferrals(){try{const e=CONFIG.getMainApiUrl(),r="&_t="+Date.now(),t=await fetch(`${e}?sheet=referral_history${r}`);if(!t.ok)return console.error("Failed to fetch referrals:",t.status),[];const n=await t.json();return Array.isArray(n)?n:n&&Array.isArray(n.result)?n.result:n&&n.result?Array.isArray(n.result)?n.result:[n.result]:[]}catch(e){return console.error("Error fetching referrals:",e),[]}}function generateReferralCode(e){return`REF-${(e||"USR").replace(/\s/g,"").substring(0,4).toUpperCase()}${Math.floor(1e3+9e3*Math.random())}`}async function ensureReferralCode(e){try{if(e.referral_code&&e.referral_code.trim())return e.referral_code.trim();const r=generateReferralCode(e.nama,e.whatsapp),t=CONFIG.getMainApiUrl(),n=await apiPost(t,{action:"update",sheet:"users",id:e.id,data:{referral_code:r}});return n&&n.updated?(console.log("âœ… Referral code generated:",r),e.referral_code=r,r):(console.warn("âš ï¸ Failed to update referral code"),r)}catch(r){return console.error("Error ensuring referral code:",r),generateReferralCode(e.nama,e.whatsapp)}}async function createReferralRecord(e,r,t){if(!e||!t)return!1;try{const n=CONFIG.getMainApiUrl(),a=(new Date).toLocaleString("id-ID",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),o=`ref_${Date.now()}`,i=await apiPost(n,{action:"create",sheet:"referral_history",data:{id:o,referrer_code:e,referee_name:t,referee_whatsapp:normalizePhoneTo08(r),event_type:"registration",referrer_reward:50,referee_reward:0,status:"completed",created_at:a}});return!(!i||!(i.created||i.updated||i.success))}catch(e){return console.error("Error creating referral record:",e),!1}}function renderReferralList(e,r,t){if(!t)return;const n=(r||"").toString().toUpperCase(),a=e.filter(e=>(e.referrer_code||"").toString().toUpperCase()===n);if(0===a.length)return void(t.innerHTML='\n            <div class="text-center py-6 text-gray-500">\n                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>\n                </svg>\n                <p class="text-sm">Belum ada teman yang mendaftar</p>\n                <p class="text-xs mt-1">Bagikan kode referral Anda!</p>\n            </div>\n        ');a.sort((e,r)=>{const t=new Date(e.created_at||e.timestamp||e.date||0);return new Date(r.created_at||r.timestamp||r.date||0)-t});let o='<div class="space-y-2">';a.forEach(e=>{const r=new Date(e.created_at||e.date||e.timestamp).toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric"}),t={registration:"ğŸ“ Registrasi",first_order:"ğŸ›’ Order Pertama",fifth_order:"ğŸ‰ Order ke-5",milestone_10:"ğŸ† Milestone 10",milestone_20:"ğŸ† Milestone 20",milestone_50:"ğŸ† Milestone 50"}[e.event_type]||e.event_type||"Referral",n=parseInt(e.referrer_reward||e.reward_points||50)||50;o+=`\n            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">\n                <div class="flex-1">\n                    <p class="font-semibold text-gray-800 text-sm">${e.referee_name||e.referred_name||"Pengguna Baru"}</p>\n                    <p class="text-xs text-gray-500">${t} â€¢ ${r}</p>\n                </div>\n                <div class="text-right">\n                    <span class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">\n                        +${n} poin\n                    </span>\n                </div>\n            </div>\n        `}),o+="</div>",t.innerHTML=o}async function initReferralWidget(e){if(e)try{const r=await ensureReferralCode(e),t=document.getElementById("referral-code-display");t&&(t.textContent=r);const n=document.getElementById("copy-referral-code");n&&(n.onclick=()=>{navigator.clipboard.writeText(r).then(()=>{const e=n.innerHTML;n.innerHTML='\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>\n                        </svg>\n                        Tersalin!\n                    ',setTimeout(()=>{n.innerHTML=e},2e3)}).catch(e=>{console.error("Failed to copy:",e),alert("Gagal menyalin kode")})});const a=document.getElementById("share-referral-code");a&&(a.onclick=()=>{const e=`${window.location.origin}/akun.html?ref=${encodeURIComponent(r)}`,t=`https://wa.me/?text=${encodeURIComponent(`Yuk gabung di GoSembako! Gunakan kode referral saya: ${r} saat daftar dan dapatkan bonus poin! ğŸ\n${e}`)}`;window.open(t,"_blank")});const o=await fetchAllReferrals(),i=document.getElementById("referral-list");i&&renderReferralList(o,r,i);const s=e.id||e.user_id;if(s)try{const e=CONFIG.getMainApiUrl(),r=await fetch(`${e}?action=get_referral_stats&user_id=${encodeURIComponent(s)}`),t=await r.json();if(!t.error){const e=document.getElementById("referral-count");e&&(e.textContent=t.referral_count||0);const r=document.getElementById("referral-points-earned");r&&(r.textContent=t.referral_points_earned||0)}}catch(e){console.error("Error loading referral stats:",e)}}catch(e){console.error("Error initializing referral widget:",e)}}window.ReferralUI={DEFAULT_REFERRAL_REWARD_POINTS:50,fetchAllReferrals:fetchAllReferrals,ensureReferralCode:ensureReferralCode,createReferralRecord:createReferralRecord,renderReferralList:renderReferralList,initReferralWidget:initReferralWidget};