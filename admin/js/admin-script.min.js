function logout(){localStorage.removeItem("admin_logged_in"),window.location.href="login.html"}"true"!==localStorage.getItem("admin_logged_in")&&(window.location.href="login.html");let API_URL=CONFIG.getAdminApiUrl();const CATEGORIES_SHEET="categories",PRODUCTS_SHEET="products",ORDERS_SHEET="orders",TUKAR_POIN_SHEET="tukar_poin";let allProducts=[],allCategories=[],allOrders=[],allTukarPoin=[],currentOrderFilter="semua";function showSection(e){document.querySelectorAll("main > section").forEach(e=>e.classList.add("hidden")),document.getElementById(`section-${e}`).classList.remove("hidden"),document.querySelectorAll(".sidebar-item").forEach(e=>e.classList.remove("active")),document.getElementById(`nav-${e}`).classList.add("active"),document.getElementById("section-title").innerText={dashboard:"Dashboard",produk:"Produk",kategori:"Kategori",pesanan:"Pesanan","tukar-poin":"Tukar Poin",banners:"Banner Promosi","user-points":"Poin Pengguna","tiered-pricing":"Harga Grosir Bertingkat",referral:"Referral Program",pengaturan:"Pengaturan"}[e],"kategori"===e&&fetchCategories(),"produk"===e&&fetchAdminProducts(),"pesanan"===e&&fetchOrders(),"tukar-poin"===e&&fetchTukarPoin(),"banners"===e&&fetchBanners(),"user-points"===e&&fetchUserPoints(),"tiered-pricing"===e&&fetchTieredPricingProducts(),"referral"===e&&fetchReferralAnalytics(),"dashboard"===e&&(updateDashboardStats(),loadStoreStatus()),"pengaturan"===e&&loadSettings()}function loadStoreStatus(){const e=CONFIG.isStoreClosed(),t=document.getElementById("store-closed-toggle"),a=document.getElementById("store-status-label");t&&a&&(t.checked=e,e?(a.innerText="TOKO TUTUP",a.className="text-sm font-bold px-3 py-1 rounded-full bg-red-100 text-red-700"):(a.innerText="TOKO BUKA",a.className="text-sm font-bold px-3 py-1 rounded-full bg-green-100 text-green-700"))}function toggleStoreStatus(){const e=document.getElementById("store-closed-toggle").checked;CONFIG.setStoreClosed(e),loadStoreStatus(),showAdminToast(e?"Toko sekarang TUTUP":"Toko sekarang BUKA",e?"warning":"success")}async function updateDashboardStats(){try{const[e,t]=await Promise.all([fetch(`${API_URL}?sheet=products`),fetch(`${API_URL}?sheet=orders`)]),a=await e.json(),n=await t.json();document.getElementById("stat-total-produk").innerText=a.length||0,document.getElementById("stat-total-pesanan").innerText=n.length||0;const r=a.filter(e=>parseInt(e.stok)<=5).length;document.getElementById("stat-stok-menipis").innerText=r}catch(e){console.error(e)}}async function fetchOrders(){const e=document.getElementById("order-list-body");e.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Memuat data pesanan...</td></tr>';try{const e=await fetch(`${API_URL}?sheet=orders`);allOrders=await e.json(),Array.isArray(allOrders)||(allOrders=[]),renderOrderTable(),updateOrderStats()}catch(t){console.error("Error:",t),e.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-red-500">Gagal memuat data pesanan.</td></tr>'}}function updateOrderStats(){const e=allOrders.length,t=allOrders.filter(e=>"menunggu"===e.status.toLowerCase()).length,a=allOrders.reduce((e,t)=>e+(parseInt(t.total)||0),0),n=e>0?Math.round(a/e):0;document.getElementById("order-stat-total").innerText=e,document.getElementById("order-stat-pending").innerText=t,document.getElementById("order-stat-revenue").innerText=`Rp ${a.toLocaleString("id-ID")}`,document.getElementById("order-stat-avg").innerText=`Rp ${n.toLocaleString("id-ID")}`,document.getElementById("order-count-display").innerText=`(${e})`}function filterOrders(e){currentOrderFilter=e,document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active","bg-green-600","text-white"),e.classList.add("bg-gray-100","text-gray-600")}),event.target.classList.add("active","bg-green-600","text-white"),event.target.classList.remove("bg-gray-100","text-gray-600"),renderOrderTable()}function renderOrderTable(){const e=document.getElementById("order-list-body"),t="semua"===currentOrderFilter?allOrders:allOrders.filter(e=>e.status.toLowerCase()===currentOrderFilter.toLowerCase());0!==t.length?e.innerHTML=t.map(e=>`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 font-bold text-blue-600 text-xs">${e.id}</td>\n            <td class="px-6 py-4 text-sm text-gray-800 font-medium">${e.pelanggan}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${e.produk}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${e.qty}</td>\n            <td class="px-6 py-4 text-sm font-bold text-gray-800">Rp ${parseInt(e.total).toLocaleString("id-ID")}</td>\n            <td class="px-6 py-4">\n                <span class="status-badge status-${e.status.toLowerCase()}">${e.status}</span>\n            </td>\n            <td class="px-6 py-4 text-xs text-gray-500">${e.tanggal}</td>\n            <td class="px-6 py-4 text-right">\n                <select onchange="updateOrderStatus('${e.id}', this.value)" class="text-xs border rounded-lg p-1 outline-none focus:ring-1 focus:ring-green-500">\n                    <option value="">Ubah Status</option>\n                    <option value="Menunggu">Menunggu</option>\n                    <option value="Diproses">Diproses</option>\n                    <option value="Dikirim">Dikirim</option>\n                    <option value="Terima">Terima</option>\n                    <option value="Dibatalkan">Dibatalkan</option>\n                </select>\n            </td>\n        </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Tidak ada pesanan.</td></tr>'}async function fetchReferralAnalytics(){try{const e=await fetch(`${API_URL}?action=get_referral_analytics`),t=await e.json();if(!t||t.error)return void console.warn("Referral analytics error:",t&&t.error);document.getElementById("admin-total-referrals").textContent=t.total_referrals||0,document.getElementById("admin-active-referrers").textContent=t.active_referrers||0,document.getElementById("admin-points-distributed").textContent=t.points_distributed||0,document.getElementById("admin-conversion-rate").textContent=(t.conversion_rate||0)+"%";const a=document.getElementById("admin-top-referrers");a&&(a.innerHTML="",(t.top_referrers||[]).forEach((e,t)=>{const n=document.createElement("tr");n.innerHTML=`\n                    <td class="px-6 py-4 text-sm text-gray-600">${t+1}</td>\n                    <td class="px-6 py-4 text-sm font-semibold text-gray-800">${e.nama||"-"}</td>\n                    <td class="px-6 py-4 text-sm text-gray-600">${e.referral_code||"-"}</td>\n                    <td class="px-6 py-4 text-sm text-gray-600">${e.referral_count||0}</td>\n                    <td class="px-6 py-4 text-sm text-gray-600">${e.referral_points_earned||0}</td>\n                `,a.appendChild(n)}),0===(t.top_referrers||[]).length&&(a.innerHTML='<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Belum ada data referral.</td></tr>'));const n=document.getElementById("admin-referral-history");n&&(n.innerHTML="",(t.recent_referrals||[]).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                    <td class="px-6 py-4 text-sm text-gray-600">${e.created_at||"-"}</td>\n                    <td class="px-6 py-4 text-sm text-gray-800">${e.referrer_name||"-"}</td>\n                    <td class="px-6 py-4 text-sm text-gray-600">${e.referee_name||"-"}</td>\n                    <td class="px-6 py-4 text-sm text-gray-600">${e.event_type||"-"}</td>\n                    <td class="px-6 py-4 text-sm text-gray-600">+${e.referrer_reward||0}</td>\n                `,n.appendChild(t)}),0===(t.recent_referrals||[]).length&&(n.innerHTML='<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Belum ada aktivitas referral.</td></tr>'))}catch(e){console.error("Error fetching referral analytics:",e)}}function bindReferralSettingsForm(){const e=document.getElementById("admin-referral-settings-form");e&&e.addEventListener("submit",async e=>{e.preventDefault();const t={action:"update_referral_settings",data:{referrer_registration_reward:document.getElementById("setting-referrer-registration")?.value||"100",referee_registration_bonus:document.getElementById("setting-referee-registration")?.value||"50",referrer_first_order_reward:document.getElementById("setting-first-order")?.value||"50",referrer_fifth_order_reward:document.getElementById("setting-fifth-order")?.value||"200",milestone_10_referrals_reward:document.getElementById("setting-milestone-10")?.value||"500",milestone_20_referrals_reward:document.getElementById("setting-milestone-20")?.value||"1000",milestone_50_referrals_reward:document.getElementById("setting-milestone-50")?.value||"3000"}};try{const e=await apiPost(API_URL,t);e&&!e.error?showAdminToast("Pengaturan referral tersimpan!","success"):showAdminToast("Gagal menyimpan pengaturan referral.","error")}catch(e){console.error("Error saving referral settings:",e),showAdminToast("Gagal menyimpan pengaturan referral.","error")}})}function normalizePhone(e){if(!e)return"";let t=e.toString().replace(/[^0-9]/g,"");return t.startsWith("62")?t="0"+t.slice(2):t.startsWith("8")?t="0"+t:t.startsWith("0")||(t="0"+t),t}async function updateOrderStatus(e,t){if(!t)return;const a=event.target;a.disabled=!0;try{const n=allOrders.find(t=>t.id===e);if(!n)return showAdminToast("Pesanan tidak ditemukan!","error"),void(a.disabled=!1);if((await apiPost(API_URL,{action:"update",sheet:"orders",id:e,data:{status:t}})).affected>0){if("Terima"===t&&"Yes"!==n.point_processed){if(n.phone&&n.poin){const t=parseFloat(n.poin)||0,a=normalizePhone(n.phone),r=await fetch(`${API_URL}?sheet=user_points`),o=await r.json(),s=Array.isArray(o)?o.filter(e=>normalizePhone(e.phone)===a):[];let i=!1;if(Array.isArray(s)&&s.length>0){const e=parseFloat(s[0].points)||0;(await apiPost(API_URL,{action:"update",sheet:"user_points",id:s[0].id,data:{points:e+t,last_updated:(new Date).toLocaleString("id-ID")}})).affected>0&&(i=!0)}else(await apiPost(API_URL,{action:"create",sheet:"user_points",data:{id:Date.now().toString(),phone:a,points:t,last_updated:(new Date).toLocaleString("id-ID")}})).created>0&&(i=!0);i?(await apiPost(API_URL,{action:"update",sheet:"orders",id:e,data:{point_processed:"Yes"}}),showAdminToast(`Status diperbarui & +${t} poin diberikan ke ${a}`,"success")):showAdminToast("Status diperbarui, tapi gagal update poin.","warning")}}else showAdminToast("Status pesanan diperbarui!","success");const a=allOrders.findIndex(t=>t.id===e);-1!==a&&(allOrders[a].status=t,"Terima"===t&&(allOrders[a].point_processed="Yes"),renderOrderTable(),updateOrderStats())}else showAdminToast("Gagal memperbarui status di database.","error")}catch(e){console.error(e),showAdminToast("Terjadi kesalahan saat memperbarui status.","error")}finally{a.disabled=!1}}async function fetchCategories(){try{const e=await fetch(`${API_URL}?sheet=categories`);allCategories=await e.json(),renderCategoryTable(),updateCategoryDropdown()}catch(e){console.error(e)}}function renderCategoryTable(){const e=document.getElementById("category-list-body");0!==allCategories.length?(e.innerHTML=allCategories.map(e=>`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4 font-bold text-gray-800 text-sm">${e.nama}</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${e.deskripsi||"-"}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2">\n                <button onclick="openEditCategory('${e.id}', '${e.nama}', '${e.deskripsi}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button onclick="handleDeleteCategory('${e.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `).join(""),document.getElementById("category-count").innerText=`(${allCategories.length})`):e.innerHTML='<tr><td colspan="3" class="px-6 py-10 text-center text-gray-500">Belum ada kategori.</td></tr>'}function openEditCategory(e,t,a){const n=prompt("Nama Kategori:",t);if(null===n)return;const r=prompt("Deskripsi:",a);null!==r&&handleEditCategory(e,n,r)}async function handleEditCategory(e,t,a){try{(await apiPost(API_URL,{action:"update",sheet:"categories",id:e,data:{nama:t,deskripsi:a}})).affected>0&&(showAdminToast("Kategori berhasil diperbarui!","success"),fetchCategories())}catch(e){console.error(e),showAdminToast("Gagal memperbarui kategori.","error")}}async function handleDeleteCategory(e){if(confirm("Apakah Anda yakin ingin menghapus kategori ini?"))try{(await apiPost(API_URL,{action:"delete",sheet:"categories",id:e})).deleted>0&&(showAdminToast("Kategori berhasil dihapus!","success"),fetchCategories())}catch(e){console.error(e),showAdminToast("Gagal menghapus kategori.","error")}}function updateCategoryDropdown(){const e=document.getElementById("form-category");if(!e)return;const t=e.value;e.innerHTML='<option value="">-- Pilih Kategori --</option>'+allCategories.map(e=>`<option value="${e.nama}">${e.nama}</option>`).join(""),e.value=t}async function fetchAdminProducts(){document.getElementById("admin-product-list").innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data...</td></tr>';try{const e=await fetch(`${API_URL}?sheet=products`);allProducts=await e.json(),renderAdminTable(),updateDashboardStats()}catch(e){console.error(e)}}function renderAdminTable(){const e=document.getElementById("admin-product-list");0!==allProducts.length?e.innerHTML=allProducts.map(e=>`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4">\n                <div class="flex items-center gap-3">\n                    <img src="${e.gambar?e.gambar.split(",")[0]:"https://via.placeholder.com/50"}" class="w-10 h-10 object-cover rounded-lg bg-gray-100">\n                    <span class="font-bold text-gray-800 text-sm">${e.nama}</span>\n                </div>\n            </td>\n            <td class="px-6 py-4">\n                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-md text-[10px] font-bold uppercase">${e.kategori||"-"}</span>\n            </td>\n            <td class="px-6 py-4">\n                <div class="flex flex-col">\n                    ${e.harga_coret?`<span class="text-[10px] text-gray-400 line-through">Rp ${parseInt(e.harga_coret).toLocaleString("id-ID")}</span>`:""}\n                    <span class="font-bold text-green-700 text-sm">Rp ${parseInt(e.harga).toLocaleString("id-ID")}</span>\n                </div>\n            </td>\n            <td class="px-6 py-4">\n                <span class="text-sm ${parseInt(e.stok)<=5?"text-red-600 font-bold":"text-gray-600"}">${e.stok}</span>\n            </td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2">\n                <button onclick="openEditModal('${e.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button onclick="handleDelete('${e.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada produk.</td></tr>'}function openAddModal(){document.getElementById("modal-title").innerText="Tambah Produk",document.getElementById("product-id").value="",document.getElementById("product-form").reset(),document.getElementById("variants-container").innerHTML="",document.getElementById("product-modal").classList.remove("hidden")}function openEditModal(e){const t=allProducts.find(t=>t.id==e);if(!t)return;document.getElementById("modal-title").innerText="Edit Produk",document.getElementById("product-id").value=t.id,document.getElementById("form-nama").value=t.nama,document.getElementById("form-harga").value=t.harga,document.getElementById("form-harga-coret").value=t.harga_coret||"",document.getElementById("form-stok").value=t.stok,document.getElementById("form-category").value=t.kategori||"",document.getElementById("form-deskripsi").value=t.deskripsi||"";const a=t.gambar?t.gambar.split(","):[];document.getElementById("form-gambar-1").value=a[0]||"",document.getElementById("form-gambar-2").value=a[1]||"",document.getElementById("form-gambar-3").value=a[2]||"",loadVariants(t.variasi),document.getElementById("product-modal").classList.remove("hidden")}function closeModal(){document.getElementById("product-modal").classList.add("hidden")}async function handleDelete(e){if(confirm("Apakah Anda yakin ingin menghapus produk ini?"))try{(await apiPost(API_URL,{action:"delete",sheet:"products",id:e})).deleted>0&&(showAdminToast("Produk berhasil dihapus!","success"),fetchAdminProducts())}catch(e){console.error(e),showAdminToast("Gagal menghapus produk.","error")}}async function fetchTukarPoin(){const e=document.getElementById("tukar-poin-list");e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Memuat data tukar poin...</td></tr>';try{const e=await fetch(`${API_URL}?sheet=tukar_poin`);if(!e.ok)throw new Error(`HTTP ${e.status}`);allTukarPoin=await e.json(),Array.isArray(allTukarPoin)||(allTukarPoin=[]),renderTukarPoinTable()}catch(t){console.error("Error:",t),e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuat data tukar poin. Pastikan sheet "tukar_poin" sudah ada.</td></tr>'}}function renderTukarPoinTable(){const e=document.getElementById("tukar-poin-list");0!==allTukarPoin.length?e.innerHTML=allTukarPoin.map(e=>`\n        <tr class="hover:bg-gray-50 transition">\n            <td class="px-6 py-4">\n                <div class="flex items-center gap-3">\n                    <img src="${e.gambar||"https://via.placeholder.com/50"}" class="w-10 h-10 object-cover rounded-lg bg-gray-100" alt="${e.judul}">\n                    <span class="font-bold text-gray-800 text-sm">${e.judul||e.nama}</span>\n                </div>\n            </td>\n            <td class="px-6 py-4 font-bold text-amber-600 text-sm">${e.poin} Poin</td>\n            <td class="px-6 py-4 text-sm text-gray-600">${e.deskripsi||"-"}</td>\n            <td class="px-6 py-4 text-right flex justify-end gap-2">\n                <button onclick="openEditTukarPoinModal('${e.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Edit">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>\n                </button>\n                <button onclick="handleDeleteTukarPoin('${e.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Hapus">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>\n                </button>\n            </td>\n        </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Belum ada produk tukar poin.</td></tr>'}function openAddTukarPoinModal(){document.getElementById("tukar-poin-id").value="",document.getElementById("tukar-poin-form").reset(),document.getElementById("tukar-poin-modal-title").innerText="Tambah Produk Tukar Poin",document.getElementById("tukar-poin-submit-btn").innerText="Simpan",document.getElementById("tukar-poin-modal").classList.remove("hidden")}function openEditTukarPoinModal(e){const t=allTukarPoin.find(t=>t.id===e);t?(document.getElementById("tukar-poin-id").value=t.id,document.getElementById("form-tukar-judul").value=t.judul||"",document.getElementById("form-tukar-poin").value=t.poin||"",document.getElementById("form-tukar-gambar").value=t.gambar||"",document.getElementById("form-tukar-deskripsi").value=t.deskripsi||"",document.getElementById("tukar-poin-modal-title").innerText="Edit Produk Tukar Poin",document.getElementById("tukar-poin-submit-btn").innerText="Perbarui",document.getElementById("tukar-poin-modal").classList.remove("hidden")):showAdminToast("Produk tidak ditemukan!","error")}function closeTukarPoinModal(){document.getElementById("tukar-poin-modal").classList.add("hidden"),document.getElementById("tukar-poin-form").reset()}async function handleDeleteTukarPoin(e){if(confirm("Apakah Anda yakin ingin menghapus produk tukar poin ini?"))try{(await apiPost(API_URL,{action:"delete",sheet:"tukar_poin",id:e})).deleted>0?(showAdminToast("Produk tukar poin berhasil dihapus!","success"),fetchTukarPoin()):showAdminToast("Gagal menghapus produk.","error")}catch(e){console.error(e),showAdminToast("Gagal menghapus produk.","error")}}async function fetchUserPoints(){const e=document.getElementById("user-points-list");e.innerHTML='<tr><td colspan="4" class="px-6 py-10 text-center text-gray-500">Memuat data...</td></tr>';try{const t=await fetch(`${API_URL}?sheet=user_points`),a=await t.json();if(0===a.length)return void(e.innerHTML='<tr><td colspan="4" class="px-6 py-10 text-center text-gray-500">Belum ada data poin pengguna.</td></tr>');e.innerHTML=a.map(e=>`\n            <tr class="hover:bg-gray-50 transition">\n                <td class="px-6 py-4 font-bold text-gray-800 text-sm">${e.phone}</td>\n                <td class="px-6 py-4 font-bold text-green-600 text-sm">${parseFloat(e.points).toFixed(1)} Poin</td>\n                <td class="px-6 py-4 text-xs text-gray-500">${e.last_updated||"-"}</td>\n                <td class="px-6 py-4 text-right">\n                    <button onclick="editUserPoints('${e.phone}', ${e.points})" class="text-blue-600 hover:underline text-sm font-bold">Edit Poin</button>\n                </td>\n            </tr>\n        `).join("")}catch(e){console.error(e)}}async function editUserPoints(e,t){const a=prompt(`Masukkan saldo poin baru untuk ${e}:`,t);if(null!==a&&""!==a)try{const t=await fetch(`${API_URL}?sheet=user_points`),n=(await t.json()).find(t=>t.phone===e);if(!n||!n.id)return void showAdminToast("User tidak ditemukan!","error");(await apiPost(API_URL,{action:"update",sheet:"user_points",id:n.id,data:{points:parseFloat(a),last_updated:(new Date).toLocaleString("id-ID")}})).affected>0&&(showAdminToast("Saldo poin diperbarui!","success"),fetchUserPoints())}catch(e){console.error(e),showAdminToast("Gagal memperbarui poin.","error")}}function loadSettings(){const e=CONFIG.getAllConfig();document.getElementById("settings-main-api").value=e.mainApi,document.getElementById("settings-admin-api").value=e.adminApi,document.getElementById("gajian-target-day").value=e.gajian.targetDay,document.getElementById("gajian-default-markup").value=100*e.gajian.defaultMarkup,renderGajianMarkups(e.gajian.markups),document.getElementById("reward-point-value").value=e.reward.pointValue,document.getElementById("reward-min-point").value=e.reward.minPoint,renderRewardOverrides(e.reward.manualOverrides)}function renderGajianMarkups(e){document.getElementById("gajian-markups-table").innerHTML=e.map((e,t)=>`\n        <tr class="border-b border-gray-50">\n            <td class="py-2 px-2">${e.minDays} Hari</td>\n            <td class="py-2 px-2 font-bold text-green-600">${(100*e.rate).toFixed(1)}%</td>\n            <td class="py-2 px-2">\n                <button onclick="openEditMarkupModal(${t})" class="text-blue-600 hover:underline">Edit</button>\n            </td>\n        </tr>\n    `).join("")}function renderRewardOverrides(e){document.getElementById("reward-overrides-table").innerHTML=Object.entries(e).map(([e,t])=>`\n        <tr class="border-b border-gray-50">\n            <td class="py-2 px-2">${e}</td>\n            <td class="py-2 px-2 font-bold text-amber-600">${t} Poin</td>\n            <td class="py-2 px-2">\n                <button onclick="deleteRewardOverride('${e}')" class="text-red-600 hover:underline">Hapus</button>\n            </td>\n        </tr>\n    `).join("")}async function saveSettings(){const e=document.getElementById("settings-main-api").value.trim(),t=document.getElementById("settings-admin-api").value.trim();if(!e||!t)return void showAdminToast("URL API tidak boleh kosong!","error");CONFIG.setMainApiUrl(e),CONFIG.setAdminApiUrl(t),API_URL=t,"undefined"!=typeof ApiService&&(ApiService.clearCache(),console.log("âœ… Cache cleared after API URL change"));const a=parseInt(document.getElementById("gajian-target-day").value),n=parseFloat(document.getElementById("gajian-default-markup").value)/100,r=CONFIG.getGajianConfig();CONFIG.setGajianConfig({...r,targetDay:a,defaultMarkup:n});const o=parseInt(document.getElementById("reward-point-value").value),s=parseFloat(document.getElementById("reward-min-point").value),i=CONFIG.getRewardConfig();CONFIG.setRewardConfig({...i,pointValue:o,minPoint:s}),window.dispatchEvent(new Event("api-config-changed")),console.log("ðŸ”” [ADMIN] Dispatched api-config-changed event to all listeners");const d=`âœ… Pengaturan Berhasil Disimpan!\n\nðŸ“¡ Main API: ${e.substring(0,40)}...\nðŸ”§ Admin API: ${t.substring(0,40)}...\nðŸ—‘ï¸ Cache cleared\n\nâ³ Reloading...`;alert(d),showAdminToast("Pengaturan berhasil disimpan! Halaman akan reload...","success"),setTimeout(()=>location.reload(),1500)}function openEditMarkupModal(e){const t=CONFIG.getGajianConfig().markups[e];t&&(document.getElementById("edit-markup-index").value=e,document.getElementById("edit-markup-min-days").value=t.minDays,document.getElementById("edit-markup-rate").value=(100*t.rate).toFixed(1),document.getElementById("edit-markup-modal").classList.remove("hidden"))}function closeEditMarkupModal(){document.getElementById("edit-markup-modal").classList.add("hidden")}function openAddOverrideModal(){document.getElementById("override-modal-title").innerText="Tambah Override Poin",document.getElementById("reward-override-form").reset(),document.getElementById("override-product-name").innerHTML='<option value="">-- Pilih Produk --</option>'+allProducts.map(e=>`<option value="${e.nama}">${e.nama}</option>`).join(""),document.getElementById("reward-override-modal").classList.remove("hidden")}function closeRewardOverrideModal(){document.getElementById("reward-override-modal").classList.add("hidden")}function deleteRewardOverride(e){if(!confirm(`Hapus override untuk ${e}?`))return;const t=CONFIG.getRewardConfig();delete t.manualOverrides[e],CONFIG.setRewardConfig(t),renderRewardOverrides(t.manualOverrides),showAdminToast("Override poin dihapus!","success")}function showAdminToast(e,t="info"){let a=document.getElementById("admin-toast-container");a||(a=document.createElement("div"),a.id="admin-toast-container",a.className="fixed bottom-8 right-8 z-[100] flex flex-col gap-3",document.body.appendChild(a));const n=document.createElement("div");n.className=`${{success:"bg-green-600",error:"bg-red-600",warning:"bg-amber-500",info:"bg-blue-600"}[t]||"bg-gray-800"} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-in-right min-w-[300px]`;const r={success:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',error:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',warning:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',info:'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'};n.innerHTML=`\n        <div class="flex-shrink-0">${r[t]||r.info}</div>\n        <div class="flex-1 font-medium text-sm">${e}</div>\n        <button onclick="this.parentElement.remove()" class="flex-shrink-0 hover:bg-white/20 p-1 rounded-lg transition">\n            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>\n        </button>\n    `,a.appendChild(n),setTimeout(()=>{n.parentElement&&(n.classList.add("animate-fade-out"),setTimeout(()=>n.remove(),500))},4e3)}function loadVariants(e){if(document.getElementById("variants-container").innerHTML="",e)try{const t=JSON.parse(e);Array.isArray(t)&&t.length>0&&t.forEach((e,t)=>{renderVariantRow(e,t)})}catch(e){console.error("Error parsing variants:",e)}}function renderVariantRow(e,t){const a=document.getElementById("variants-container"),n=document.createElement("div");n.className="bg-white p-4 rounded-lg border border-gray-200 variant-row",n.dataset.index=t;const r=e.harga_coret||"",o=e.gambar||"",s=e.grosir||"";n.innerHTML=`\n        <div class="grid grid-cols-2 gap-3 mb-3">\n            <div>\n                <label class="text-xs font-bold text-gray-600">SKU</label>\n                <input type="text" class="variant-sku w-full p-2 border rounded text-sm" value="${e.sku||""}" placeholder="MG-1L" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Nama Varian</label>\n                <input type="text" class="variant-nama w-full p-2 border rounded text-sm" value="${e.nama||""}" placeholder="1 Liter" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Harga (Rp)</label>\n                <input type="number" class="variant-harga w-full p-2 border rounded text-sm" value="${e.harga||""}" placeholder="15000" required>\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Harga Coret (Rp)</label>\n                <input type="number" class="variant-harga-coret w-full p-2 border rounded text-sm" value="${r}" placeholder="16000">\n            </div>\n            <div>\n                <label class="text-xs font-bold text-gray-600">Stok</label>\n                <input type="number" class="variant-stok w-full p-2 border rounded text-sm" value="${e.stok||""}" placeholder="10" required>\n            </div>\n            <div class="col-span-2">\n                <label class="text-xs font-bold text-gray-600">URL Gambar Varian (Opsional)</label>\n                <input type="text" class="variant-gambar w-full p-2 border rounded text-sm mb-2" value="${o}" placeholder="https://example.com/variant-image.jpg" onchange="previewVariantImage(this)">\n                <p class="text-[10px] text-gray-500 mb-2">Jika diisi, gambar ini akan tampil saat varian dipilih. Jika kosong, akan gunakan gambar produk utama.</p>\n                ${o?`<img src="${o}" class="variant-image-preview w-24 h-24 object-cover rounded border" onerror="this.style.display='none'">`:""}\n            </div>\n        </div>\n        <div class="mb-3">\n            <label class="text-xs font-bold text-gray-600">Harga Grosir (JSON)</label>\n            <textarea class="variant-grosir w-full p-2 border rounded text-xs" rows="2" placeholder='[{"min_qty":5,"price":14000}]'>${s}</textarea>\n        </div>\n        <div class="flex justify-end">\n            <button type="button" onclick="removeVariantRow(this)" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm font-bold transition">\n                Hapus Varian\n            </button>\n        </div>\n    `,a.appendChild(n)}function addVariantRow(){renderVariantRow({},document.getElementById("variants-container").children.length)}function removeVariantRow(e){e.closest(".variant-row").remove()}function collectVariants(){const e=document.querySelectorAll(".variant-row"),t=[];return e.forEach(e=>{const a=e.querySelector(".variant-sku").value.trim(),n=e.querySelector(".variant-nama").value.trim(),r=e.querySelector(".variant-harga").value.trim(),o=e.querySelector(".variant-harga-coret").value.trim(),s=e.querySelector(".variant-stok").value.trim(),i=e.querySelector(".variant-gambar").value.trim(),d=e.querySelector(".variant-grosir").value.trim();if(a&&n&&r&&s){const e={sku:a,nama:n,harga:parseInt(r),stok:parseInt(s)};o&&(e.harga_coret=parseInt(o)),i&&(e.gambar=i),d&&(e.grosir=d),t.push(e)}}),t}function previewVariantImage(e){const t=e.value.trim(),a=e.closest(".variant-row").querySelector(".variant-image-preview");if(a&&a.remove(),t){const a=document.createElement("img");a.src=t,a.className="variant-image-preview w-24 h-24 object-cover rounded border mt-2",a.onerror=function(){this.style.display="none",showToast("Gagal memuat gambar. Periksa URL gambar.","error")},e.parentElement.appendChild(a)}}function updateCacheCount(){if("undefined"!=typeof ApiService){const e=ApiService.getCacheStats(),t=document.getElementById("cache-count");t&&(t.textContent=e.totalEntries)}}function clearApiCache(){if("undefined"==typeof ApiService)return void alert("ApiService tidak tersedia.");if(!confirm("Hapus semua cache API? Data akan di-fetch ulang dari server."))return;const e=ApiService.clearCache();alert(`âœ… Cache berhasil dihapus!\n\n${e} entries dihapus.`),updateCacheCount()}function viewCacheStats(){if("undefined"==typeof ApiService)return void alert("ApiService tidak tersedia.");const e=ApiService.getCacheStats();let t="ðŸ“Š STATISTIK CACHE API\n\n";t+=`Total Entries: ${e.totalEntries}\n`,t+=`Pending Requests: ${e.pendingRequests}\n\n`,e.entries.length>0?(t+="DETAIL CACHE:\n",t+=`${"=".repeat(40)}\n\n`,e.entries.forEach((e,a)=>{const n=e.key.split(":")[1]?.split("?")[1]||"unknown";t+=`${a+1}. ${n}\n`,t+=`   Age: ${e.age}s\n`,t+=`   Size: ${(e.size/1024).toFixed(2)} KB\n\n`})):t+="Tidak ada cache tersimpan.",alert(t)}async function testMainApi(){const e=document.getElementById("settings-main-api").value.trim(),t=document.getElementById("main-api-status");if(e)if(e.startsWith("http://")||e.startsWith("https://")){showApiStatus(t,"loading","â³ Testing API...");try{const a=`${e}?sheet=products`,n=await fetch(a);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=await n.json();if(!Array.isArray(r))throw new Error('Response bukan array. Pastikan sheet "products" ada di spreadsheet.');showApiStatus(t,"success",`âœ… API Valid! Ditemukan ${r.length} produk.`)}catch(e){console.error("API Test Error:",e),showApiStatus(t,"error",`âŒ API Error: ${e.message}`)}}else showApiStatus(t,"error","âŒ API URL harus dimulai dengan http:// atau https://");else showApiStatus(t,"error","âŒ API URL tidak boleh kosong!")}async function testAdminApi(){const e=document.getElementById("settings-admin-api").value.trim(),t=document.getElementById("admin-api-status");if(e)if(e.startsWith("http://")||e.startsWith("https://")){showApiStatus(t,"loading","â³ Testing API...");try{const a=`${e}?sheet=products`,n=await fetch(a);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=await n.json();if(!Array.isArray(r))throw new Error('Response bukan array. Pastikan sheet "products" ada di spreadsheet.');showApiStatus(t,"success",`âœ… API Valid! Ditemukan ${r.length} produk.`)}catch(e){console.error("API Test Error:",e),showApiStatus(t,"error",`âŒ API Error: ${e.message}`)}}else showApiStatus(t,"error","âŒ API URL harus dimulai dengan http:// atau https://");else showApiStatus(t,"error","âŒ API URL tidak boleh kosong!")}function showApiStatus(e,t,a){e.classList.remove("hidden","bg-green-100","text-green-700","bg-red-100","text-red-700","bg-yellow-100","text-yellow-700"),"success"===t?e.classList.add("bg-green-100","text-green-700"):"error"===t?e.classList.add("bg-red-100","text-red-700"):"loading"===t&&e.classList.add("bg-yellow-100","text-yellow-700"),e.textContent=a}document.getElementById("product-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("product-id").value,a=document.getElementById("submit-btn"),n=a.innerText;a.disabled=!0,a.innerText="Menyimpan...";const r=[document.getElementById("form-gambar-1").value,document.getElementById("form-gambar-2").value,document.getElementById("form-gambar-3").value].filter(e=>""!==e.trim()).join(","),o=collectVariants(),s=o.length>0?JSON.stringify(o):"",i={nama:document.getElementById("form-nama").value,harga:document.getElementById("form-harga").value,harga_coret:document.getElementById("form-harga-coret").value,stok:document.getElementById("form-stok").value,kategori:document.getElementById("form-category").value,deskripsi:document.getElementById("form-deskripsi").value,gambar:r,variasi:s};try{const e=t?"update":"create",a=t||Date.now().toString(),n=await apiPost(API_URL,{action:e,sheet:"products",id:a,data:t?i:{...i,id:a}});(n.affected>0||n.created>0)&&(showAdminToast(t?"Produk berhasil diperbarui!":"Produk berhasil ditambahkan!","success"),closeModal(),fetchAdminProducts())}catch(e){console.error(e),showAdminToast("Terjadi kesalahan saat menyimpan data.","error")}finally{a.disabled=!1,a.innerText=n}}),document.getElementById("category-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("form-category-nama").value,a=document.getElementById("form-category-deskripsi").value,n=e.target.querySelector('button[type="submit"]'),r=n.innerHTML;n.disabled=!0,n.innerHTML="Menyimpan...";try{(await apiPost(API_URL,{action:"create",sheet:"categories",data:{id:Date.now().toString(),nama:t,deskripsi:a}})).created>0&&(showAdminToast("Kategori berhasil ditambahkan!","success"),e.target.reset(),fetchCategories())}catch(e){console.error(e),showAdminToast("Terjadi kesalahan saat menyimpan data.","error")}finally{n.disabled=!1,n.innerHTML=r}}),document.getElementById("tukar-poin-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("tukar-poin-id").value,a=document.getElementById("form-tukar-judul").value.trim(),n=document.getElementById("form-tukar-poin").value.trim(),r=document.getElementById("form-tukar-gambar").value.trim(),o=document.getElementById("form-tukar-deskripsi").value.trim();if(!a||!n||!r)return void showAdminToast("Semua field yang ditandai wajib diisi!","error");const s=e.target.querySelector('button[type="submit"]'),i=s.innerHTML;s.disabled=!0,s.innerHTML="Menyimpan...";try{const e={judul:a,poin:parseInt(n),gambar:r,deskripsi:o},s=t?"update":"create",i=t||Date.now().toString(),d=await apiPost(API_URL,{action:s,sheet:"tukar_poin",id:i,data:t?e:{...e,id:i}});d.created>0||d.affected>0?(showAdminToast(t?"Produk tukar poin berhasil diperbarui!":"Produk tukar poin berhasil ditambahkan!","success"),closeTukarPoinModal(),fetchTukarPoin()):showAdminToast("Gagal menyimpan data.","error")}catch(e){console.error(e),showAdminToast("Gagal menyimpan data.","error")}finally{s.disabled=!1,s.innerHTML=i}}),document.getElementById("edit-markup-form").addEventListener("submit",e=>{e.preventDefault();const t=parseInt(document.getElementById("edit-markup-index").value),a=parseInt(document.getElementById("edit-markup-min-days").value),n=parseFloat(document.getElementById("edit-markup-rate").value)/100,r=CONFIG.getGajianConfig();r.markups[t]={minDays:a,rate:n},r.markups.sort((e,t)=>t.minDays-e.minDays),CONFIG.setGajianConfig(r),renderGajianMarkups(r.markups),closeEditMarkupModal(),showAdminToast("Skema markup diperbarui!","success")}),document.getElementById("reward-override-form").addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("override-product-name").value,a=parseFloat(document.getElementById("override-point-value").value),n=CONFIG.getRewardConfig();n.manualOverrides[t]=a,CONFIG.setRewardConfig(n),renderRewardOverrides(n.manualOverrides),closeRewardOverrideModal(),showAdminToast("Override poin disimpan!","success")}),document.addEventListener("DOMContentLoaded",()=>{showSection("dashboard"),bindReferralSettingsForm()}),document.addEventListener("DOMContentLoaded",()=>{setInterval(updateCacheCount,5e3),updateCacheCount()});